<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QBIT TRIVIA - Pro Edition</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

<style>
:root{
--bg-dark:#1a1f32;
--card-bg:#242a45;
--text-red:#ff4d6d;
--accent-green:#00e676;
--btn-blue:#2d365d;
--text-dim:#8a94b8;
}

body{
background:var(--bg-dark);
color:white;
font-family:'Arial Black',sans-serif;
display:flex;
justify-content:center;
align-items:center;
min-height:100vh;
margin:0;
overflow-y: auto;
}

/* ANIMACI√ìN DE FLOTADO PARA EL LOGO */
@keyframes float {
    0% { transform: translateY(0px) rotate(0deg); }
    50% { transform: translateY(-15px) rotate(2deg); }
    100% { transform: translateY(0px) rotate(0deg); }
}

.logo-app {
    width: 180px; /* Tama√±o optimizado para que luzca el logo */
    height: auto;
    margin-bottom: 20px;
    filter: drop-shadow(0 10px 15px rgba(0, 0, 0, 0.5));
    animation: float 3s ease-in-out infinite; /* Activamos el movimiento */
}

.timer-container{
width:100%;
height:8px;
background:#1e2640;
position:absolute;
top:0;left:0;
z-index: 10;
}
#timer-bar{
width:100%;
height:100%;
background:var(--accent-green);
transition:width .1s linear;
}

.timer-urgent {
    background: var(--text-red) !important;
    animation: blink 0.5s infinite;
}

@keyframes blink {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.container{
background:var(--card-bg);
width:95%;
max-width:500px;
padding:30px;
border-radius:20px;
text-align:center;
box-shadow:0 15px 40px rgba(0,0,0,.6);
position:relative;
margin: 20px 0;
transition: 0.3s;
}

.hidden{display:none}

.option-btn{
background:var(--btn-blue);
color:white;
padding:14px;
width:100%;
margin-bottom:10px;
border-radius:12px;
border:2px solid transparent;
font-weight:bold;
cursor:pointer;
transition:.2s;
}
.option-btn:hover:not(:disabled){
background:#3d4670;
border-color:var(--accent-green);
transform:scale(1.02);
}
.option-btn:disabled{opacity:.6}

.score-bar{
margin-top:20px;
padding-top:15px;
border-top:2px solid #3d4670;
display:flex;
justify-content:space-between;
color:var(--accent-green);
font-family:sans-serif;
font-weight:bold;
}

.time-msg{
font-size:.8rem;
color:var(--text-dim);
margin-top:10px;
font-family:sans-serif;
min-height:1.8rem;
}

.flash-success{box-shadow:0 0 40px var(--accent-green) !important;}
.flash-error{
    animation: shake 0.4s !important;
    box-shadow:0 0 40px var(--text-red) !important;
}

@keyframes shake {
    0% { transform: translateX(0); }
    25% { transform: translateX(-12px); }
    50% { transform: translateX(12px); }
    75% { transform: translateX(-12px); }
    100% { transform: translateX(0); }
}

input{
padding:12px;
border-radius:10px;
border:none;
width:90%;
margin:15px 0;
font-size:1rem;
background: #1e2640;
color: white;
text-align: center;
}
button.start-btn{
background:var(--accent-green);
border:none;
padding:14px;
width:100%;
border-radius:12px;
font-weight:bold;
cursor:pointer;
margin-top:10px;
}

.chart-box {
    margin: 20px 0;
    padding: 10px;
    background: rgba(0,0,0,0.2);
    border-radius: 10px;
}
canvas { max-width: 100%; }
</style>
</head>

<body>

<div class="timer-container"><div id="timer-bar"></div></div>

<div class="container" id="menu">
    <img src="logo.png" alt="Logo QBIT" class="logo-app">
    <h1>QBIT TRIVIA</h1>
    <p style="color:var(--text-dim)">¬°Prep√°rate para el desaf√≠o m√°s divertido!</p>
    <input id="playerName" placeholder="Escribe tu apodo aqu√≠">
    <button class="start-btn" onclick="startGame()">¬°A Jugar!</button>
</div>

<div class="container hidden" id="game">
<h1>QBIT TRIVIA</h1>
<div id="question">Cargando desaf√≠o...</div>
<div id="meta-container" class="time-msg"></div>
<div id="options-container"></div>

<div class="score-bar">
<span><span id="player-label"></span> ‚Ä¢ PUNTOS: <span id="score-value">0</span></span>
<span id="counter">1 / 10</span>
</div>

<div id="time-result" class="time-msg"></div>
</div>

<div class="container hidden" id="end">
<h1>üèÅ ¬°Partida Terminada!</h1>
<p id="final-player"></p>
<p id="final-score" style="font-size: 1.5rem; color: var(--accent-green)"></p>

<div class="chart-box">
    <p style="font-size: 0.8rem; color: var(--text-dim)">¬øEN QU√â ERES CRACK?</p>
    <canvas id="radarChart"></canvas>
</div>

<div class="chart-box">
    <p style="font-size: 0.8rem; color: var(--text-dim)">TUS REFLEJOS (SEGUNDOS)</p>
    <canvas id="barChart"></canvas>
</div>

<h3>üèÜ Los Mejores de Hoy</h3>
<div id="ranking" style="font-family: sans-serif; font-size: 0.85rem; text-align: left;"></div>

<button class="start-btn" onclick="restart()">¬°Quiero revancha!</button>
</div>

<audio id="snd-ok" preload="auto" src="https://www.soundjay.com/buttons/sounds/button-3.mp3"></audio>
<audio id="snd-bad" preload="auto" src="https://www.soundjay.com/buttons/sounds/button-10.mp3"></audio>
<audio id="snd-time" preload="auto" src="https://www.soundjay.com/misc/sounds/fail-trombone-01.mp3"></audio>
<audio id="snd-tick" preload="auto" src="https://www.soundjay.com/clock/sounds/clock-ticking-2.mp3" loop></audio>

<script>
let score=0,startTime,timer;
let questionCount=0;
let streak=0;
const MAX_QUESTIONS=10;
const TIME_LIMIT=15;
const API_URL="https://qbit-e6gb.onrender.com/pregunta-random";

let gameData = {
    labels: [],
    times: [],
    accuracy: {}
};

function unlockAudio() {
    const audios = [
        document.getElementById("snd-ok"),
        document.getElementById("snd-bad"),
        document.getElementById("snd-time"),
        document.getElementById("snd-tick")
    ];
    audios.forEach(a => {
        a.play().catch(()=>{});
        a.pause();
        a.currentTime = 0;
    });
}

function startGame(){
unlockAudio();
score=0; streak=0; questionCount=0;
gameData = { labels: [], times: [], accuracy: {} };
document.getElementById("score-value").innerText=0;
document.getElementById("menu").classList.add("hidden");
document.getElementById("end").classList.add("hidden");
document.getElementById("game").classList.remove("hidden");
document.getElementById("player-label").innerText=
document.getElementById("playerName").value||"Jugador Estrella";
fetchNewQuestion();
}

function restart(){
document.getElementById("end").classList.add("hidden");
document.getElementById("menu").classList.remove("hidden");
}

function deepClean(t){return t?.toString().trim().replace(/^['"]|['"]$/g,'')||""}

function parseOptions(o){
if(Array.isArray(o)&&o.length===1)return parseOptions(o[0]);
if(Array.isArray(o))return o.map(deepClean);
if(typeof o==="string"){
try{return JSON.parse(o.replace(/'/g,'"')).map(deepClean)}catch{return[]}
}
return[];
}

async function fetchNewQuestion() {
if(questionCount>=MAX_QUESTIONS) return endGame();
questionCount++;
document.getElementById("counter").innerText=`Pregunta ${questionCount} de ${MAX_QUESTIONS}`;

clearInterval(timer);
document.getElementById("snd-tick").pause();
document.getElementById("timer-bar").classList.remove("timer-urgent");

const opt=document.getElementById("options-container");
const bar=document.getElementById("timer-bar");
const msg=document.getElementById("time-result");
opt.innerHTML = "";
msg.innerText = "¬°Conc√©ntrate!";
bar.style.width = "100%";

try {
    const r=await fetch(API_URL+"?t="+Date.now());
    const d=await r.json();

    const categoria = deepClean(d.categoria);
    document.getElementById("question").innerText=deepClean(d.pregunta);
    document.getElementById("meta-container").innerText=`Categor√≠a: ${categoria}`;

    if(!gameData.accuracy[categoria]) gameData.accuracy[categoria] = {correct: 0, total: 0};
    gameData.accuracy[categoria].total++;
    gameData.currentCat = categoria;

    parseOptions(d.opciones).forEach(o=>{
        const b=document.createElement("button");
        b.className="option-btn";
        b.innerText=o;
        b.onclick=()=>check(o,d.correcta);
        opt.appendChild(b);
    });

    startTime=Date.now();
    startTimer();
} catch (e) {
    document.getElementById("question").innerText="¬°Error de conexi√≥n!";
}
}

function startTimer(){
const bar=document.getElementById("timer-bar");
timer=setInterval(()=>{
const t=(Date.now()-startTime)/1000;
const timeLeft = TIME_LIMIT - t;
bar.style.width=Math.max(0,(timeLeft/TIME_LIMIT)*100)+"%";

if(timeLeft <= 5 && timeLeft > 0) {
    bar.classList.add("timer-urgent");
    document.getElementById("snd-tick").play();
}

if(t>=TIME_LIMIT){
    clearInterval(timer);
    document.getElementById("snd-tick").pause();
    streak=0;
    gameData.times.push(TIME_LIMIT);
    document.getElementById("time-result").innerText="‚è∞ ¬°TIEMPO!";
    document.getElementById("snd-time").play();
    setTimeout(fetchNewQuestion,1500);
}
},50);
}

function check(sel,correct){
clearInterval(timer);
document.getElementById("snd-tick").pause();
const cleanCorrect=deepClean(correct);
const timeSpent=(Date.now()-startTime)/1000;
gameData.times.push(timeSpent.toFixed(2));

let pts=Math.max(2,Math.ceil((TIME_LIMIT-timeSpent)*2));
const msg=document.getElementById("time-result");
const card=document.getElementById("game");

if(sel===cleanCorrect){
    streak++;
    gameData.accuracy[gameData.currentCat].correct++;
    confetti({ particleCount: 80, spread: 60, origin: { y: 0.7 } });

    if(streak%3===0) pts+=10; 
    score+=pts;
    document.getElementById("score-value").innerText=score;
    document.getElementById("snd-ok").play();
    msg.innerText=`‚úÖ Correcto +${pts} pts`;
    card.classList.add("flash-success");
} else {
    streak=0;
    document.getElementById("snd-bad").play();
    msg.innerText=`‚ùå Era: ${cleanCorrect}`;
    card.classList.add("flash-error");
}

document.querySelectorAll('.option-btn').forEach(b => b.disabled = true);

setTimeout(()=>{
    card.classList.remove("flash-success","flash-error");
    fetchNewQuestion();
},2000);
}

function endGame(){
clearInterval(timer);
document.getElementById("snd-tick").pause();
document.getElementById("game").classList.add("hidden");
document.getElementById("end").classList.remove("hidden");

confetti({ particleCount: 150, spread: 180, origin: { y: 0.6 } });

const name=document.getElementById("player-label").innerText;
document.getElementById("final-player").innerText=`¬°Buen juego, ${name}!`;
document.getElementById("final-score").innerText=`Sumaste ${score} puntos`;

let ranking=JSON.parse(localStorage.getItem("qbit-ranking")||"[]");
ranking.push({name,score});
ranking.sort((a,b)=>b.score-a.score);
ranking=ranking.slice(0,5);
localStorage.setItem("qbit-ranking",JSON.stringify(ranking));

document.getElementById("ranking").innerHTML=
ranking.map((r,i)=>`${i+1}. ${r.name} ‚Äî ${r.score} pts`).join("<br>");

renderCharts();
}

function renderCharts() {
    const ctxRadar = document.getElementById('radarChart').getContext('2d');
    const labels = Object.keys(gameData.accuracy);
    const accuracyData = labels.map(l => (gameData.accuracy[l].correct / gameData.accuracy[l].total) * 100);

    new Chart(ctxRadar, {
        type: 'radar',
        data: {
            labels: labels,
            datasets: [{
                label: '% de Acierto',
                data: accuracyData,
                backgroundColor: 'rgba(0, 230, 118, 0.2)',
                borderColor: '#00e676',
                pointBackgroundColor: '#00e676'
            }]
        },
        options: { 
            scales: { r: { beginAtZero: true, max: 100, grid: {color: '#3d4670'}, ticks: {display: false} } },
            plugins: { legend: { display: false } }
        }
    });

    const ctxBar = document.getElementById('barChart').getContext('2d');
    new Chart(ctxBar, {
        type: 'bar',
        data: {
            labels: gameData.times.map((_, i) => `Q${i+1}`),
            datasets: [{
                label: 'Segundos',
                data: gameData.times,
                backgroundColor: '#ff4d6d'
            }]
        },
        options: { 
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, grid: {color: '#3d4670'} } }
        }
    });
}
</script>

</body>
</html>