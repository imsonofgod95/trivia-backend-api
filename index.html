<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QBIT TRIVIA - Battle Royale Edition</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<style>
:root{
--bg-dark:#0a0c14;
--card-bg: rgba(36, 42, 69, 0.7);
--text-red:#ff4d6d;
--accent-green:#00e676;
--btn-blue:#2d365d;
--text-dim:#8a94b8;
}

body{
background: radial-gradient(circle at center, #1a1f32 0%, #0a0c14 100%);
color:white;
font-family:'Arial Black',sans-serif;
display:flex;
justify-content:center;
align-items:center;
min-height:100vh;
margin:0;
overflow-y: auto;
}

@keyframes float {
    0% { transform: translateY(0px) rotate(0deg); }
    50% { transform: translateY(-15px) rotate(2deg); }
    100% { transform: translateY(0px) rotate(0deg); }
}

.logo-app {
    width: 640px; 
    max-width: 100%; 
    height: auto;
    margin-bottom: 10px;
    filter: drop-shadow(0 15px 25px rgba(0, 0, 0, 0.6));
    animation: float 3s ease-in-out infinite;
    border: 0;
}

.radar {
    width: 120px; height: 120px; border: 2px solid var(--accent-green);
    border-radius: 50%; margin: 20px auto; position: relative; overflow: hidden;
}
.radar::after {
    content: ""; position: absolute; width: 100%; height: 100%;
    top: 0; left: 0; background: conic-gradient(from 0deg, transparent, var(--accent-green));
    animation: rotate 2s linear infinite; opacity: 0.3; transform-origin: center;
}
@keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

.timer-container{
width:100%; height:8px; background:#1e2640;
position:absolute; top:0; left:0; z-index: 10;
}
#timer-bar{
width:100%; height:100%; background:var(--accent-green);
transition:width .1s linear;
}

.container{
background: var(--card-bg); backdrop-filter: blur(12px);
-webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1);
width: 95%; max-width: 700px; padding: 40px; border-radius: 30px;
text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.8);
position: relative; margin: 20px 0; transition: 0.3s;
}

.hidden{display:none}

#leaderboard-box {
    position: absolute; left: -220px; top: 0; width: 200px;
    background: var(--card-bg); padding: 15px; border-radius: 20px;
    border: 1px solid rgba(255,255,255,0.1); text-align: left;
    font-size: 0.8rem;
}
@media (max-width: 1100px) { #leaderboard-box { position: static; width: 90%; margin: 10px auto; } }

.duel-status {
    display: flex; justify-content: space-around; align-items: center;
    background: rgba(0,0,0,0.4); padding: 15px; border-radius: 20px;
    margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1);
}

.vs-badge { background: var(--text-red); padding: 4px 12px; border-radius: 8px; font-size: 0.9rem; font-weight: bold; }

.option-btn{
background:var(--btn-blue); color:white; padding: 18px; width:100%;
margin-bottom:12px; border-radius:15px; border: 1px solid rgba(255,255,255,0.1);
font-weight:bold; font-size: 1.1rem; cursor:pointer; transition:.2s;
}
.option-btn:hover:not(:disabled){ background:#3d4670; border-color:var(--accent-green); transform:scale(1.02); }

input, select {
padding:15px; border-radius:12px; border:none; width:90%; margin:10px 0;
font-size:1.1rem; background: #1e2640; color: white; text-align: center;
}

.start-btn {
background:var(--accent-green); border:none; padding:16px; width:100%;
border-radius:15px; font-weight:bold; cursor:pointer; margin-top:10px;
}

.massive-grid {
    display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 20px;
}
.btn-massive { background: #4a5568; font-size: 0.8rem; padding: 12px; }

.time-msg { font-size:.8rem; color:var(--text-dim); margin-top:10px; min-height:1.8rem; }
.flash-success{box-shadow:0 0 40px var(--accent-green) !important;}
.flash-error{ animation: shake 0.4s !important; box-shadow:0 0 40px var(--text-red) !important; }
@keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-12px); } 50% { transform: translateX(12px); } 75% { transform: translateX(-12px); } }

.score-bar { margin-top:20px; padding-top:15px; border-top:2px solid #3d4670; display:flex; justify-content:space-between; color:var(--accent-green); font-weight:bold; }
</style>
</head>

<body>

<div class="timer-container"><div id="timer-bar"></div></div>

<div class="container" id="menu">
    <img src="logo.png" onerror="this.src='https://i.ibb.co/LdpXW4P/logo-qbit.png'" class="logo-app">
    <p style="color:var(--accent-green); font-size: 1.1rem; margin-top: -10px; text-shadow: 0 0 10px var(--accent-green);">"DOMINA EL C√ìDIGO, CONQUISTA EL CONOCIMIENTO"</p>
    
    <input id="playerName" placeholder="Tu Apodo">
    
    <div style="display: flex; gap: 10px; margin-top: 10px;">
        <button class="start-btn" onclick="iniciarModoSolitario()">Aventura Solo üöÄ</button>
        <button class="start-btn" onclick="iniciarBusqueda()" style="background: var(--btn-blue)">Duelo 1vs1 ‚öîÔ∏è</button>
    </div>

    <p style="color:var(--text-dim); margin-top: 20px; font-size: 0.8rem;">SALAS MULTIJUGADOR MASIVAS</p>
    <div class="massive-grid">
        <button class="start-btn btn-massive" onclick="unirseAMasiva(10)">SALA 10 üë•</button>
        <button class="start-btn btn-massive" onclick="unirseAMasiva(25)">SALA 25 üë•</button>
        <button class="start-btn btn-massive" onclick="unirseAMasiva(50)">SALA 50 üë•</button>
    </div>
    
    <p id="reward-info" style="margin-top: 20px; font-size: 0.9rem; color: var(--accent-green)"></p>
</div>

<div class="container hidden" id="lobby">
    <div class="radar"></div>
    <h2 id="lobby-title" style="color:var(--accent-green)">Esperando Jugadores...</h2>
    <h1 id="lobby-timer-display" style="font-size: 3rem; margin: 10px 0;">30</h1>
    <p id="lobby-count">Jugadores: 1 / --</p>
    <button class="start-btn" style="background:var(--text-red)" onclick="location.reload()">Salir</button>
</div>

<div class="container hidden" id="game">
    <div id="leaderboard-box" class="hidden">
        <p style="color:var(--accent-green); margin-bottom: 10px; font-size: 0.7rem;">TOP POSICIONES</p>
        <div id="leaderboard-list"></div>
    </div>

    <div class="duel-status" id="duel-ui">
        <div><div style="font-size:0.7rem;">T√ö</div><div id="my-duel-score" style="color:var(--accent-green); font-size: 1.5rem;">0</div></div>
        <div class="vs-badge">VS</div>
        <div><div id="opp-name-label" style="font-size:0.7rem;">RIVAL</div><div id="opp-duel-score" style="color:var(--text-red); font-size: 1.5rem;">0</div></div>
    </div>

    <div id="meta-container"></div> 
    <div id="question">Preparando...</div>
    <div id="options-container"></div>

    <div class="score-bar">
        <span>PREGUNTA <span id="counter-val">1</span> / 10</span>
    </div>
    <div id="time-result" class="time-msg"></div>
</div>

<div class="container hidden" id="end">
    <h1 id="win-loss-title">üèÅ Partida Terminada</h1>
    <p id="final-duel-score" style="font-size: 1.5rem; color: var(--accent-green)"></p>
    <p id="reward-msg"></p>
    <div class="chart-box"><canvas id="radarChart"></canvas></div>
    <button class="start-btn" onclick="location.reload()">Volver al Men√∫</button>
</div>

<audio id="snd-tick" preload="auto" src="https://www.soundjay.com/clock/sounds/clock-ticking-2.mp3" loop></audio>
<audio id="snd-ok" preload="auto" src="https://www.soundjay.com/buttons/sounds/button-3.mp3"></audio>
<audio id="snd-bad" preload="auto" src="https://www.soundjay.com/buttons/sounds/button-10.mp3"></audio>

<script>
const API_BASE = "https://qbit-e6gb.onrender.com";
const socket = io(API_BASE);

let score=0, oppScore=0, startTime, timer, currentRoom = null;
let questionCount=0, streak=0, soloMode = false, isMassive = false;
let qbits = parseInt(localStorage.getItem("qbit-balance") || "0");

document.getElementById("reward-info").innerText = `üí∞ Mis Qbits: ${qbits}`;

// --- MODOS DE JUEGO ---

function unirseAMasiva(size) {
    isMassive = true; soloMode = false;
    const name = document.getElementById("playerName").value || "Jugador";
    document.getElementById("menu").classList.add("hidden");
    document.getElementById("lobby").classList.remove("hidden");
    document.getElementById("lobby-title").innerText = "Esperando Jugadores...";
    socket.emit("join_massive_lobby", { name, size });
}

function iniciarBusqueda() {
    isMassive = false; soloMode = false;
    const name = document.getElementById("playerName").value || "Jugador";
    socket.emit("join_queue", { name, rank: 1000, difficulty: "Random" });
    document.getElementById("menu").classList.add("hidden");
    document.getElementById("lobby").classList.remove("hidden");
    document.getElementById("lobby-title").innerText = "Buscando Rival...";
}

function iniciarModoSolitario() {
    soloMode = true; isMassive = false;
    document.getElementById("menu").classList.add("hidden");
    document.getElementById("game").classList.remove("hidden");
    document.getElementById("duel-ui").classList.add("hidden");
    document.getElementById("leaderboard-box").classList.add("hidden");
    startGame();
}

// --- EVENTOS SOCKET ---

socket.on("lobby_update", (data) => {
    document.getElementById("lobby-count").innerText = `Jugadores: ${data.count} / ${data.size}`;
});

socket.on("lobby_timer", (data) => {
    document.getElementById("lobby-timer-display").innerText = data.seconds;
});

socket.on("start_massive_game", (data) => {
    currentRoom = data.room;
    document.getElementById("lobby").classList.add("hidden");
    document.getElementById("game").classList.remove("hidden");
    document.getElementById("duel-ui").classList.add("hidden");
    document.getElementById("leaderboard-box").classList.remove("hidden");
    startGame(data.first_question);
});

socket.on("match_found", (data) => {
    currentRoom = data.room;
    document.getElementById("opp-name-label").innerText = data.opponent.toUpperCase();
    document.getElementById("lobby").classList.add("hidden");
    document.getElementById("game").classList.remove("hidden");
    document.getElementById("duel-ui").classList.remove("hidden");
    document.getElementById("leaderboard-box").classList.add("hidden");
    startGame(data.first_question);
});

socket.on("leaderboard_update", (data) => {
    const list = document.getElementById("leaderboard-list");
    list.innerHTML = data.slice(0, 5).map((p, i) => 
        `<div style="margin-bottom:5px; color: ${p.score > 0 ? '#00e676' : 'white'}">${i+1}. ${p.name}: ${p.score}</div>`
    ).join("");
});

socket.on("receive_question", (question) => displayQuestion(question));
socket.on("update_opponent_score", (data) => {
    oppScore = data.score;
    document.getElementById("opp-duel-score").innerText = oppScore;
});

function startGame(firstQ = null) {
    score=0; oppScore=0; streak=0; questionCount=0;
    document.getElementById("my-duel-score").innerText = "0";
    document.getElementById("opp-duel-score").innerText = "0";
    if(soloMode) fetchSoloQuestion();
    else if(firstQ) displayQuestion(firstQ);
}

// --- L√ìGICA DE TRIVIA ---

async function fetchSoloQuestion() {
    const r = await fetch(`${API_BASE}/pregunta-random`);
    const d = await r.json();
    displayQuestion(d);
}

function displayQuestion(d) {
    questionCount++;
    document.getElementById("counter-val").innerText = questionCount;
    clearInterval(timer);
    const opt = document.getElementById("options-container");
    opt.innerHTML = "";
    document.getElementById("timer-bar").style.width = "100%";
    document.getElementById("question").innerText = d.pregunta;
    document.getElementById("meta-container").innerText = d.categoria;

    parseOptions(d.opciones).forEach(o => {
        const b = document.createElement("button");
        b.className = "option-btn"; b.innerText = o;
        b.onclick = () => check(o, d.correcta);
        opt.appendChild(b);
    });
    startTime = Date.now();
    startTimer();
}

function check(sel, correct) {
    clearInterval(timer);
    const cleanCorrect = correct.trim();
    const timeSpent = (Date.now() - startTime) / 1000;
    const card = document.getElementById("game");

    if (sel.trim() === cleanCorrect) {
        let pts = Math.max(2, Math.ceil((15 - timeSpent) * 2));
        streak++;
        if (streak % 3 === 0) pts += 10;
        score += pts;
        document.getElementById("my-duel-score").innerText = score;
        if (currentRoom) socket.emit("score_update", { room: currentRoom, score: score });
        confetti({ particleCount: 30 });
        document.getElementById("snd-ok").play().catch(()=>{});
        card.classList.add("flash-success");
    } else { 
        streak = 0; 
        document.getElementById("snd-bad").play().catch(()=>{});
        card.classList.add("flash-error");
    }

    document.querySelectorAll('.option-btn').forEach(b => b.disabled = true);
    setTimeout(() => {
        card.classList.remove("flash-success","flash-error");
        if (questionCount < 10) {
            if (soloMode) fetchSoloQuestion();
            else socket.emit("next_question", { room: currentRoom, index: questionCount });
        } else endGame();
    }, 1500);
}

function startTimer() {
    timer = setInterval(() => {
        const t = (Date.now() - startTime) / 1000;
        document.getElementById("timer-bar").style.width = Math.max(0, (1 - t/15)*100) + "%";
        if (t >= 15) { clearInterval(timer); check("", "---"); }
    }, 50);
}

function endGame() {
    document.getElementById("game").classList.add("hidden");
    document.getElementById("end").classList.remove("hidden");
    document.getElementById("final-duel-score").innerText = `Puntaje Final: ${score}`;
    let reward = Math.floor(score / 10);
    qbits += reward;
    localStorage.setItem("qbit-balance", qbits);
    document.getElementById("reward-msg").innerText = `+${reward} Qbits ganados ü™ô`;
    renderCharts();
}

function parseOptions(o) {
    if (typeof o === "string") return o.split("|");
    return o;
}

function renderCharts() {
    const ctx = document.getElementById('radarChart').getContext('2d');
    new Chart(ctx, {
        type: 'radar',
        data: {
            labels: ['Agilidad', 'Racha', 'Aciertos'],
            datasets: [{ 
                data: [score, streak*10, score/2], 
                borderColor: '#00e676',
                backgroundColor: 'rgba(0, 230, 118, 0.2)'
            }]
        },
        options: { plugins: { legend: { display: false } }, scales: { r: { ticks: { display: false } } } }
    });
}
</script>
</body>
</html>